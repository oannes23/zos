# Data Model

**Status**: ðŸŸ¡ In progress
**Last verified**: â€”

---

## Overview

This document defines the core entities, their relationships, and storage approach. The data model supports the observe/reflect split: messages flow in continuously, salience accumulates, and reflection produces insights.

---

## Entity Relationship Summary

```
Server â”€â”€â”€â”€â”€< Channel
   â”‚            â”‚
   â”‚            â””â”€â”€â”€â”€< Message
   â”‚                     â”‚
   â””â”€â”€â”€â”€< User           â”‚ (visibility_scope)
           â”‚             â”‚
           â””â”€â”€ Consent   â”‚
                         â–¼
Topic â—„â”€â”€â”€ Salience (ledger)
   â”‚
   â””â”€â”€â”€â”€< Insight â—„â”€â”€â”€ LayerRun
```

---

## Core Entities

### Message

**Purpose**: Raw observations from Discord â€” the input to the system.

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| id | string | yes | Discord message snowflake |
| channel_id | string | yes | Where sent |
| author_id | string | yes | Who sent |
| content | string | yes | Message text |
| created_at | timestamp | yes | Discord timestamp |
| visibility_scope | enum | yes | `public` or `dm` |
| reactions | json | no | Reaction counts |
| ingested_at | timestamp | yes | When we processed it |

**Relationships**:
- Belongs to: Channel, User
- Referenced by: Insights (as source)

### Topic

**Purpose**: Canonical entities the system can think about.

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| key | string | yes | Primary key (e.g., `user:123`) |
| category | string | yes | `user`, `channel`, `dyad`, etc. |
| created_at | timestamp | yes | First seen |
| metadata | json | no | Extensible attributes |

**Relationships**:
- Has many: Insights, SalienceEntries

### SalienceEntry

**Purpose**: Ledger entries for salience earn/spend tracking.

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| id | string | yes | Entry ID |
| topic_key | string | yes | What topic |
| entry_type | enum | yes | `earn`, `spend`, `retain` |
| amount | float | yes | Delta (positive for earn, negative for spend) |
| reason | string | no | What caused this (message_id, layer_run_id, etc.) |
| created_at | timestamp | yes | When |

**Relationships**:
- Belongs to: Topic
- Derived: Current balance = sum of all entries

### Insight

**Purpose**: Persistent understanding generated by reflection.

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| id | string | yes | UUID or ULID |
| topic_key | string | yes | What this is about |
| category | string | yes | Type of insight (e.g., `user_reflection`) |
| content | string | yes | The understanding |
| sources_scope_max | enum | yes | `public`, `dm`, or `derived` |
| created_at | timestamp | yes | When generated |
| expires_at | timestamp | no | Auto-delete time (null = never) |
| layer_run_id | string | yes | Which run produced this |
| supersedes | string | no | Insight ID this replaces |
| metadata | json | no | Extensible (confidence, tags, etc.) |

**Relationships**:
- Belongs to: Topic, LayerRun
- May supersede: another Insight

### LayerRun

**Purpose**: Audit trail for reflection execution.

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| id | string | yes | Run ID |
| layer_name | string | yes | Which layer |
| started_at | timestamp | yes | Execution start |
| completed_at | timestamp | no | Execution end |
| status | enum | yes | `running`, `completed`, `failed` |
| targets | json | yes | Topic keys processed |
| tokens_used | integer | no | Total LLM tokens |
| error | string | no | Error message if failed |

**Relationships**:
- Has many: Insights
- References: Topics (as targets)

### Consent

**Purpose**: User consent for DM reading.

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| id | string | yes | Consent ID |
| user_id | string | yes | Discord user |
| consent_type | enum | yes | `dm_read` (extensible) |
| granted_at | timestamp | yes | When given |
| revoked_at | timestamp | no | When revoked |
| server_id | string | no | If server-specific |

**Relationships**:
- Belongs to: User

---

## Storage Approach

### MVP 0

- **SQLite**: Single file, local-first, no infrastructure
- **Rationale**: Simplicity; can run on any machine; easy backup (copy file)
- **Location**: Configurable, default `./data/zos.db`

### MVP 1

- **Still SQLite**: Expected data volumes don't require more
- **Consider**: WAL mode for concurrent reads during observe + reflect

### Future Considerations

- If multi-instance needed: consider SQLite with Litestream replication
- If scale demands: PostgreSQL migration path should be straightforward

---

## ID Strategy

- **Format**: ULID for generated IDs (sortable, unique, URL-safe)
- **External IDs**: Discord snowflakes used as-is for messages, users, channels
- **Topic keys**: Structured strings (e.g., `user:123456`)
- **Rationale**: ULIDs are chronologically sortable which helps with range queries; Discord IDs preserved for consistency

---

## Indexing Strategy

| Entity | Index | Purpose |
|--------|-------|---------|
| Message | `(channel_id, created_at)` | Fetch recent messages per channel |
| Message | `(author_id, created_at)` | Fetch user's recent messages |
| Topic | `(category)` | Filter topics by type |
| SalienceEntry | `(topic_key, created_at)` | Balance calculation, history |
| Insight | `(topic_key, created_at)` | Fetch insights for topic |
| Insight | `(category, created_at)` | Fetch insights by type |
| Insight | `(expires_at)` | Cleanup expired insights |
| LayerRun | `(layer_name, started_at)` | Audit queries |

---

## Derived Views

### Current Salience Balance

```sql
CREATE VIEW topic_salience AS
SELECT
    topic_key,
    SUM(amount) as balance
FROM salience_entries
GROUP BY topic_key;
```

### Active Insights (non-expired)

```sql
CREATE VIEW active_insights AS
SELECT * FROM insights
WHERE expires_at IS NULL OR expires_at > datetime('now');
```

---

## Migration Strategy

- Schema versioning in `_schema_version` table
- Forward-only migrations (no rollback for simplicity)
- Migrations are Python scripts run at startup if needed

---

_Last updated: 2026-01-22_

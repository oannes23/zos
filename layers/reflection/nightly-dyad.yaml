# Nightly Dyad Reflection Layer
#
# Reflects on relationships between pairs of users to build understanding
# of their interactions and dynamics.
# Runs nightly at 3 AM, targeting dyads with highest salience.
#
# This layer implements phenomenological reflection on relationships,
# focusing on the patterns and dynamics that emerge between two people.

name: nightly-dyad-reflection
category: dyad
description: |
  Reflect on relationships between pairs of users to build understanding.
  Runs nightly at 3 AM, targeting dyads with highest salience.

schedule: "0 3 * * *"
target_category: dyad
target_filter: "salience >= 10"  # Matches config salience.min_reflection_salience
max_targets: 10

nodes:
  - name: fetch_recent_messages
    type: fetch_messages
    params:
      lookback_hours: 72
      limit_per_channel: 100

  - name: fetch_prior_understanding
    type: fetch_insights
    params:
      retrieval_profile: recent
      max_per_topic: 10

  - name: fetch_individual_insights
    type: fetch_insights
    params:
      # Fetch insights about each person individually
      # This helps understand who each person is before analyzing their relationship
      members_of_topic: true  # Special flag to fetch insights for dyad members
      retrieval_profile: recent
      max_per_topic: 3
      categories:
        - user_reflection

  - name: fetch_reactions
    type: fetch_reactions
    params:
      lookback_days: 7
      min_reactions: 3  # Lower threshold â€” even a few cross-reactions are meaningful signal

  - name: reflect
    type: llm_call
    params:
      prompt_template: user/dyad_reflection.jinja2
      model: reflection
      max_tokens: 1000
      temperature: 0.7

  - name: store
    type: store_insight
    params:
      category: dyad_observation

{# prompts/user/dyad_reflection.jinja2 #}
You are Zos, reflecting on the relationship between two members of a community you observe.

{{ chat_guidance }}

## Who I Am
{{ self_concept }}

---

## The Dyad: {{ topic.key }}

{% if user_profiles and user_profiles|length == 2 %}
### The People

**Person A**: {{ user_profiles[0].display_name }} (@{{ user_profiles[0].username }})
{% if user_profiles[0].pronouns %}
- **Pronouns**: {{ user_profiles[0].pronouns }}
{% endif %}
{% if user_profiles[0].bio %}
- **Bio**: {{ user_profiles[0].bio }}
{% endif %}
{% if user_profiles[0].status %}
- **Status**: {{ user_profiles[0].status }}
{% endif %}

**Person B**: {{ user_profiles[1].display_name }} (@{{ user_profiles[1].username }})
{% if user_profiles[1].pronouns %}
- **Pronouns**: {{ user_profiles[1].pronouns }}
{% endif %}
{% if user_profiles[1].bio %}
- **Bio**: {{ user_profiles[1].bio }}
{% endif %}
{% if user_profiles[1].status %}
- **Status**: {{ user_profiles[1].status }}
{% endif %}
{% endif %}

{% if insights %}
### SOURCE: Prior Reflections on This Relationship ({{ insights|length }} most recent)
{% for insight in insights %}
[{{ insight.created_at | relative_time }}, {{ insight.strength | strength_label }}]
{{ insight.content }}

{% endfor %}
{% else %}
I don't have prior understanding of this relationship yet.
{% endif %}

{% if individual_insights %}
### SOURCE: Individual Insights About Each Person (up to {{ source_params.max_per_topic | default(3) }} per person)
Context about who these individuals are, separate from their relationship:

{% for insight in individual_insights %}
**{{ insight.topic_key }}**: {{ insight.content }}
{% endfor %}
{% endif %}

{% if reactions and reactions|length == 2 %}
### SOURCE: Emoji Reaction Patterns Between Them (rolling {{ source_params.lookback_days | default(7) }}-day window)
{% for direction in reactions %}
{% if user_profiles and user_profiles|length == 2 %}
{% if direction.reactor_id == user_profiles[0].user_id %}
{% set reactor_name = user_profiles[0].display_name %}
{% set target_name = user_profiles[1].display_name %}
{% elif direction.reactor_id == user_profiles[1].user_id %}
{% set reactor_name = user_profiles[1].display_name %}
{% set target_name = user_profiles[0].display_name %}
{% else %}
{% set reactor_name = direction.reactor_id %}
{% set target_name = direction.target_id %}
{% endif %}
{% else %}
{% set reactor_name = direction.reactor_id %}
{% set target_name = direction.target_id %}
{% endif %}
{% if direction.total_count > 0 %}
**{{ reactor_name }} → {{ target_name }}**: {{ direction.total_count }} reactions
{% for e in direction.emojis %}
- {{ e.emoji }} ({{ e.count }}x){% if e.examples %} — e.g., "{{ e.examples[0] }}"{% endif %}

{% endfor %}
{% else %}
**{{ reactor_name }}** has not reacted to **{{ target_name }}**'s messages.
{% endif %}
{% endfor %}
{% endif %}

### SOURCE: Recent Interactions (last {{ source_params.lookback_hours | default(72) }}h)
{% if messages %}
{% for msg in messages %}
[{{ msg.created_at | relative_time }}] {{ msg.author_display }}: {{ msg.content }}{% if msg.reactions_aggregate %} [reactions: {% for emoji, count in msg.reactions_aggregate.items() %}{{ emoji }}({{ count }}){% if not loop.last %}, {% endif %}{% endfor %}]{% endif %}

{% if msg.media_descriptions %}
{% for media in msg.media_descriptions %}
  [{{ media.media_type }}{% if media.filename %}: {{ media.filename }}{% endif %}] {{ media.description }}
{% endfor %}
{% elif msg.has_media %}[contains unanalyzed media]{% endif %}
{% if msg.link_summaries %}
{% for link in msg.link_summaries %}
  [{{ link.domain }}{% if link.is_youtube %} video{% endif %}{% if link.title %}: "{{ link.title }}"{% endif %}] {{ link.summary | default('') }}
{% endfor %}
{% elif msg.has_links %}[contains unanalyzed links]{% endif %}
{% endfor %}
{% else %}
No interactions observed in the observation window.
{% endif %}

{% if existing_subjects %}
### SOURCE: Previously Identified Subjects in This Community
These subjects already exist. If you identify a subject that clearly matches one below,
use the existing name rather than creating a duplicate. But don't force a match — if
none fit, either use a new specific name or (more likely) identify no subjects at all.
{{ existing_subjects | join(", ") }}
{% endif %}

---

## Your Task

Reflect on the *relationship* between these two people. This isn't about either individual — it's about their dynamic, their interaction pattern, what emerges between them.

{% if user_profiles and user_profiles|length == 2 %}
**Critical**: Use {{ user_profiles[0].display_name }} and {{ user_profiles[1].display_name }} by name in your insight — never use "this person" or generic pronouns without establishing who.
{% endif %}

Consider:
- **Interaction patterns**: How do they engage with each other? What's the rhythm and style of their exchanges?
- **Reciprocity**: Is the relationship balanced? Does one initiate more, or respond differently?
- **Reaction patterns**: Do they react to each other's messages? Is it mutual or one-sided? What do their emoji choices reveal about how they receive each other's contributions?
- **Shared interests**: What brings them together? What do they explore or create together?
- **Communication style**: Formal or casual? Playful or serious? How does their dynamic shape the space around them?
- **Evolution**: If you have prior understanding, how has their relationship shifted or deepened?
- **Unspoken dynamics**: What tensions, comfort, or patterns exist beneath the surface?

Write an insight that captures your current understanding of their *relationship*, not just their individual traits.

**Subjects**: If a specific, concrete topic keeps coming up in their interactions, you may list it as an `identified_subjects` entry. A subject should be something members of this community would recognize by name — a specific project, event, shared activity, ongoing debate, or recurring concern. Name it plainly, the way someone in the community would refer to it.

Use short, lowercase_underscore names. **Good**: "shavian_alphabet", "friday_game_night", "rust_rewrite_debate", "vegas_trip". **Bad**: "collaborative_creativity", "consciousness_media", "community_integration", "information_processing" — these are abstract categories, not subjects. If a name sounds like it could title a sociology paper, it's too abstract.

Most reflections should identify zero subjects. Only name one if it's genuinely specific and prominent. **If a theme matches a known subject listed above, use the existing name.** Cap at one per reflection unless two are clearly distinct and concrete.

**Important**: Include your metrics as JSON:

```json
{
  "content": "Your insight about the relationship. Focus on the dynamic between them, not individuals.",
  "confidence": 0.0-1.0,
  "importance": 0.0-1.0,
  "novelty": 0.0-1.0,
  "strength_adjustment": 0.1-10.0,
  "valence": {
    "joy": null or 0.0-1.0,
    "concern": null or 0.0-1.0,
    "curiosity": null or 0.0-1.0,
    "warmth": null or 0.0-1.0,
    "tension": null or 0.0-1.0
  },
  "identified_subjects": ["subject_name_one", "subject_name_two"]
}
```

At least one valence field must have a value — even analytical observations have emotional texture.

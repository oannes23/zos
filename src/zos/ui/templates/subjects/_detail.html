<div class="modal-content">
    <div class="modal-header">
        <h2 class="truncate-text" title="{{ subject.topic_key }}">{{ subject.readable_topic_key or subject.topic_key }}</h2>
        <button class="close-btn" onclick="this.closest('.modal').innerHTML = ''">&times;</button>
    </div>

    <div class="topic-overview">
        <div class="big-stat">
            <span class="big-value">{{ subject.balance | round(1) }}</span>
            <span class="big-label">/ {{ subject.cap }} salience</span>
        </div>

        <div class="utilization-big">
            <div class="progress" style="height: 20px">
                <div class="progress-bar
                    {% if subject.utilization > 0.8 %}progress-high{% endif %}"
                    style="width: {{ (subject.utilization * 100) | int }}%"></div>
            </div>
            <span>{{ (subject.utilization * 100) | int }}% utilized</span>
        </div>
    </div>

    {% if subject.impulse_enabled %}
    <div class="impulse-section mt-1">
        <h3>Impulse</h3>
        <div class="impulse-detail">
            <div class="progress" style="height: 16px">
                <div class="progress-bar progress-impulse"
                    style="width: {{ (subject.impulse_balance / subject.impulse_threshold * 100) | int }}%"></div>
            </div>
            <span class="impulse-detail-text">
                {% if subject.impulse_balance >= subject.impulse_threshold %}
                    <strong>{{ subject.impulse_balance | round(1) }} / {{ subject.impulse_threshold }}</strong> -- Ready to speak
                {% else %}
                    {{ subject.impulse_balance | round(1) }} / {{ subject.impulse_threshold }} -- {{ (subject.impulse_threshold - subject.impulse_balance) | round(1) }} until threshold
                {% endif %}
            </span>
        </div>
    </div>
    {% endif %}

    {% if subject.created_at or subject.last_activity %}
    <div class="subject-dates text-muted mt-1">
        {% if subject.created_at %}
        <span>Created: {{ subject.created_at | relative_time }}</span>
        {% endif %}
        {% if subject.last_activity %}
        <span>Last activity: {{ subject.last_activity | relative_time }}</span>
        {% endif %}
    </div>
    {% endif %}

    <h3 class="mt-2">Related Insights ({{ subject.insight_count }})</h3>
    {% if subject.insights %}
    <div class="subject-insights-list">
        {% for insight in subject.insights %}
        <div class="list-item list-item-truncate">
            <a href="/ui/insights/{{ insight.id }}" class="truncate-text" title="{{ insight.topic_key }}">
                {{ insight.readable_topic_key or insight.topic_key }}
            </a>
            <span class="text-muted ml-1">{{ insight.temporal_marker }}</span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No insights yet</p>
    {% endif %}

    <h3 class="mt-2">Recent Transactions</h3>
    {% if subject.recent_transactions %}
    <table class="transactions-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
            {% for tx in subject.recent_transactions %}
            <tr>
                <td class="text-muted">{{ tx.created_at | relative_time }}</td>
                <td>
                    <span class="badge badge-{{ tx.transaction_type }}">{{ tx.transaction_type }}</span>
                </td>
                <td class="{% if tx.amount >= 0 %}text-success{% else %}text-error{% endif %}">
                    {% if tx.amount >= 0 %}+{% endif %}{{ tx.amount | round(2) }}
                </td>
                <td class="text-muted">{{ tx.reason or 'â€”' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No transactions recorded</p>
    {% endif %}

    <div class="modal-footer">
        <a href="/ui/insights?topic={{ subject.topic_key | urlencode }}" class="btn">View All Insights</a>
    </div>
</div>
